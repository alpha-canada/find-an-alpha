<link rel="import"
      href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import"
      href="../neon-animation/neon-animatable-behavior.html">
<link rel="import"
      href="./css/modules/list-view.html">

<dom-module id="list-view">
  <template strip-whitespace>
    <style include="module:list-view"></style>
    <div id="nav-bar">
      <a id="backToSearch"
         on-tap='backToSearch'>
        <i class="icon-edit"></i>Edit Search</a>
    </div>
    <template is="dom-if"
              if="{{islessthan}}">
      <div id="alerts">
        <p>Only [[count]] result(s) were found with your search criteria.
          <br />Try broadening your search radius to find more Alphas.
        </p>
      </div>
    </template>

    <div id="placesError">
    </div>


    <div class="main">
      <template is="dom-repeat"
                items="{{data}}"
                id="locationList">
        <div index$="{{index}}"
             id="location"
             on-tap="_selectItem"
             class="single animating">
          <div>
            <h2>[[item.mark]]. [[item.label]]</h2>
            <span>
              <i class="icon-clock-o"></i>[[_formatDate(item.start)]]</span>
          </div>
          <template is="dom-if"
                    if={{item.distance}}>
            <p>[[item.distance]][[units]]</p>
          </template>
        </div>
      </template>
      <array-selector id="selector"
                      items="{{data}}"
                      selected="{{selected}}"></array-selector>
    </div>
  </template>

</dom-module>

<script>


  Polymer({
    is: 'list-view',
    behaviors: [
      Polymer.NeonAnimatableBehavior
    ],
    listeners: {
      'dom-change': '_onDomChanged'
    },
    properties: {
      data: {
        type: Array,
        value: function () {
          return [];
        }
      },
      count: {
        type: Number,
      },
      units: {
        type: String,
        value: "km"
      },
      selected: {
        type: Object,
        notify: true,
        // reflectToAttribute:true
      },
      islessthan: {
        type: Boolean,
        value: false,
        computed: '_countlessthan(data)'
      },
      animationConfig: {
        type: Object,
        value: function () {
          return {
            'entry': [{
              name: 'fade-in-animation',
              node: this.$.backToSearch
            }],
            'exit': [{
              name: 'fade-out-animation',
              node: this.$.backToSearch
            }, {
              name: 'hero-animation',
              id: 'hero',
              fromPage: this
            }]
          };
        }
      }
    },
    showEmptyGeoQuery: function (geoQuery, geoResult) {

      this.$.placesError.innerHTML = "<p>Sorry, we couldn't find any Alphas in: " + geoQuery + "</p>";

    },
    _selectItem: function (event) {
      var target = event.target;
      while (!target.hasAttribute('index')) {
        target = target.parentNode;
      }
      this.selectedIndex = target.getAttribute('index');
      var location = target.parentNode.childNodes;
      location.forEach(function (element) {
        element.className = "single animated style-scope list-view";
      })
      var target = event.target;
      while (!target.hasAttribute('index')) {
        target = target.parentNode;
      }
      var item = this.$.locationList.itemForElement(target);
      this.$.selector.select(item);
      while (target !== this && !target._templateInstance) {
        target = target.parentNode;
      }
      // configure the page animation
      this.sharedElements = {
        'hero': target,
      };
      this.fire('item-click', {
        item: target,
        index: this.selectedIndex
      });

    },


    backToSearch: function () {
      this.$.placesError.innerHTML = "";
      this.fire('backtosearch');
    },

    _animating: function () {
      var location = Polymer.dom(this.root).querySelectorAll("#location");
      location.forEach(function (element) {
        element.className = "single animating style-scope list-view";
      })
    },

    _onDomChanged: function () {
      this._animating();
      this.fire('domchanged');
    },

    _countlessthan: function (data) {
      if (this.count < 4) {
        return true;
      }
    },

    _formatDate: function (raw) {
      var date = moment(raw).toDate();

      var monthNames = [
        "January", "February", "March",
        "April", "May", "June", "July",
        "August", "September", "October",
        "November", "December"
      ];

      var weekdayNames = [
        "Sunday", "Monday", "Tuesday",
        "Wednesday", "Thursday", "Friday",
        "Saturday", "Sunday"
      ];

      var day = date.getDate();
      var monthIndex = date.getMonth();
      var year = date.getFullYear();
      var weekdayIndex = date.getDay();

      return weekdayNames[weekdayIndex] + ", " + monthNames[monthIndex] + ' ' + day + ', ' + year;
    },


  });

</script>