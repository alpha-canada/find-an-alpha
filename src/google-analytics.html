<link rel="import" 
      href="/bower_components/iron-signals/iron-signals.html">

<dom-module id="google-analytics">
    <template>
        <iron-signals on-iron-signal-track-event="trackEvent"></iron-signals>
    </template>
</dom-module>
<script>

    Polymer({
        is:"google-analytics",
        ready: function(){
            if (!window.ga){
                (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
            }
            if (this.options.key === undefined || this.options.key == ''){
                console.error('Google Analytics Key is not defined.')
            }else{
                ga('create', this.options['key'], 'auto', 'findAnAlpha');
            }
            
        },
        properties: {
            options : {
                type: Object,
			    value: function ( inputs ) {
                    var defaults = {
                        search: {
                            Category: "Page Engagement",
                            Action: "Search",
                            Label: "{{ placename }}",
                            Value: 0
                        },
                        calendar: {
                            Category: "Page Engagement",
                            Action: "Download Calendar",
                            Label: "{{ id }}",
                            Value: 0
                        },
                        contact: {
                            Category: "Page Engagement",
                            Action: "Contact",
                            Label: "{{ email }}",
                            Value: 0
                        },
                        edit: {
                            Category: "Page Engagement",
                            Action: "Click",
                            Label: "Edit Search",
                            Value: 0
                        },
                        marker: {
                            Category: "Page Engagement",
                            Action: "Click Marker",
                            Label: "{{ id }}",
                            Value: 0
                        },
                        key: 'UA-XXXXX-Y'
                    };
                    for ( var id in inputs.options ) {
                        for (var property in defaults[id]){
                            inputs.options[ id ][ property ] = inputs.options[ id ][ property ] || defaults[ id ][ property ];
                        }
                         
                    }
                    return inputs.options;
                }
            }
        },

        trackEvent: function(e){
            let event = e.detail.event;
            if (typeof this.options[event] !== "undefined"){
                let label = this.getEventLabel(event, e.detail);
                ga('findAnAlpha.send', 'event', this.options[event].Category, this.options[event].Action, label, this.options[event].Value);
            }
        },
        getEventLabel: function(event, data){
            let matches = this.options[event].Label.match(/{{\s*[\w\.]+\s*}}/g) ;
            if (matches != null){
                let find = matches[0].match(/[\w\.]+/)[0].toLowerCase();
                let label = "";
                switch(event){
                    case "search":
                        switch (find){
                            case "placename":
                            default:
                                label = data.place;
                        }
                        break;
                    case "calendar":
                    case "marker" : 
                        switch (find){
                            case "name":
                                label = data.alpha.label; 
                                break;
                            case "id":
                            default:
                                label = data.alpha.ID;
                        }
                        break;
                    case "contact":
                        switch (find){
                            case "email":
                            case "mail":
                            default:
                                label = data.email;
                        }
                        break;
                    default:
                        label = find;
                }
                return label;
            }
            return this.options[event].Label;
        }
    })

</script>